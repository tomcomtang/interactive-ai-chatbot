---
/**
 * AI å¯¹è¯é¡µé¢
 * åœ†è§’å¡ç‰‡èƒŒæ™¯åè½¬ï¼Œæ—  Canvas åŠ¨ç”»
 */

import EvervaultHead from '../components/EvervaultHead.astro';
import OriginalHeader from '../components/OriginalHeader.astro';
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>A2UI - AI Chat</title>
  
  <!-- EdgeOne åŸå§‹èµ„æºï¼ˆåªåŠ è½½ CSSï¼‰ -->
  <EvervaultHead />
  
  <!-- A2UI æ ·å¼ -->
  <link rel="stylesheet" href="/src/styles/a2ui.css">
  
  <!-- èŠå¤©é¡µé¢æ ·å¼ -->
  <link rel="stylesheet" href="/src/styles/chat.css">
</head>

<body>
  <!-- åŸå§‹å¯¼èˆªæ  -->
  <OriginalHeader />

  <!-- AI å¯¹è¯åŒºåŸŸ -->
  <main class="chat-section">
    <!-- å›ºå®šçš„å¡ç‰‡èƒŒæ™¯ - ç‹¬ç«‹å±‚ -->
    <div class="chat-background"></div>
    
    <!-- èŠå¤©å†…å®¹åŒºåŸŸ - ç‹¬ç«‹å±‚ -->
    <div class="chat-container">
      <!-- å¯¹è¯å†…å®¹åŒºåŸŸ -->
      <div class="chat-messages" id="chatMessages">
        <div class="welcome-message">
          <h2>ğŸ‘‹ Welcome to A2UI Chat</h2>
          <p>Hi! I'm your AI assistant. Ask me anything or try typing keywords like "profile", "products" to see UI components.</p>
        </div>
      </div>
    </div>
    
    <!-- å›ºå®šçš„è¾“å…¥æ¡† - ç‹¬ç«‹å±‚ -->
    <div class="chat-input-wrapper">
      <div class="chat-input-container">
        <textarea 
          id="chatInput" 
          class="chat-input" 
          placeholder="Type your message here..."
          rows="1"
        ></textarea>
        <button id="sendBtn" class="send-button">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
        </button>
      </div>
    </div>
  </main>
</body>

<script>
  import { A2UIRenderer } from '../lib/a2ui-renderer';
  import { allMockExamples } from '../lib/a2ui-mock-data';

  // è‡ªåŠ¨è°ƒæ•´ textarea é«˜åº¦
  const chatInput = document.getElementById('chatInput') as HTMLTextAreaElement;
  const sendBtn = document.getElementById('sendBtn');
  const chatMessages = document.getElementById('chatMessages');
  const chatInputContainer = document.querySelector('.chat-input-container') as HTMLElement;

  // ç‚¹å‡»è¾“å…¥å®¹å™¨æ—¶ï¼Œèšç„¦åˆ°è¾“å…¥æ¡†
  if (chatInputContainer && chatInput) {
    chatInputContainer.addEventListener('click', (e) => {
      // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æŒ‰é’®ï¼Œå°±èšç„¦è¾“å…¥æ¡†
      if (e.target !== sendBtn && !sendBtn?.contains(e.target as Node)) {
        chatInput.focus();
      }
    });
  }

  if (chatInput) {
    chatInput.addEventListener('input', () => {
      chatInput.style.height = 'auto';
      chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
    });

    // æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
    chatInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
  }

  if (sendBtn) {
    sendBtn.addEventListener('click', sendMessage);
  }

  function sendMessage() {
    const message = chatInput?.value.trim();
    if (!message) return;

    console.log('Sending message:', message); // è°ƒè¯•æ—¥å¿—

    // æ£€æŸ¥æ˜¯å¦æ˜¯ A2UI å‘½ä»¤
    const commandMap: Record<string, keyof typeof allMockExamples> = {
      '1': 'userProfile',
      'ç”¨æˆ·èµ„æ–™': 'userProfile',
      'user profile': 'userProfile',
      'ä¸ªäººèµ„æ–™': 'userProfile',
      
      '2': 'contactForm',
      'è”ç³»è¡¨å•': 'contactForm',
      'contact form': 'contactForm',
      'è¡¨å•': 'contactForm',
      
      '3': 'productList',
      'äº§å“åˆ—è¡¨': 'productList',
      'product list': 'productList',
      'å•†å“åˆ—è¡¨': 'productList',
      
      '4': 'settingsPanel',
      'è®¾ç½®é¢æ¿': 'settingsPanel',
      'settings panel': 'settingsPanel',
      'è®¾ç½®': 'settingsPanel',

      '5': 'table',
      'æ•°æ®è¡¨æ ¼': 'table',
      'table': 'table',
      'è¡¨æ ¼': 'table',

      '6': 'dataVisualization',
      'æ•°æ®å±•ç¤º': 'dataVisualization',
      'data visualization': 'dataVisualization',
      'å›¾è¡¨': 'dataVisualization',
      'chart': 'dataVisualization',

      '7': 'media',
      'åª’ä½“ç»„ä»¶': 'media',
      'media': 'media',
      'è§†é¢‘': 'media',
      'video': 'media',

      '8': 'advanced',
      'é«˜çº§ç»„ä»¶': 'advanced',
      'advanced': 'advanced',
      'æ—¥å†': 'advanced',
      'calendar': 'advanced'
    };

    const demoType = commandMap[message.toLowerCase()];
    console.log('Demo type:', demoType); // è°ƒè¯•æ—¥å¿—

    // æ£€æŸ¥æ˜¯å¦æœ‰æ¬¢è¿æ¶ˆæ¯
    const welcomeMsg = chatMessages?.querySelector('.welcome-message');
    
    if (welcomeMsg) {
      // å¦‚æœæœ‰æ¬¢è¿æ¶ˆæ¯ï¼Œå…ˆå¼€å§‹æ¶ˆå¤±åŠ¨ç”»
      welcomeMsg.style.transition = 'opacity 0.5s ease, transform 0.5s ease, max-height 0.5s ease, margin 0.5s ease, padding 0.5s ease';
      welcomeMsg.style.opacity = '0';
      welcomeMsg.style.transform = 'translateY(-20px)';
      welcomeMsg.style.maxHeight = '0';
      welcomeMsg.style.marginBottom = '0';
      welcomeMsg.style.paddingTop = '0';
      welcomeMsg.style.paddingBottom = '0';
      welcomeMsg.style.overflow = 'hidden';
      
      // ç«‹å³æ·»åŠ ç”¨æˆ·æ¶ˆæ¯ï¼ˆéšè—çŠ¶æ€ï¼‰
      addMessage(message, 'user', true);
      
      // 0.5ç§’åï¼ˆæ¬¢è¿æ¶ˆæ¯æ¶ˆå¤±å®Œæˆï¼‰
      setTimeout(() => {
        welcomeMsg.remove();
        
        // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
        const userMsg = chatMessages?.lastElementChild;
        if (userMsg) {
          requestAnimationFrame(() => {
            userMsg.style.opacity = '1';
            userMsg.style.maxHeight = '200px';
          });
        }
        
        // åˆ¤æ–­æ˜¯å¦æ¸²æŸ“ A2UI æˆ–æ™®é€šå›å¤
        setTimeout(() => {
          if (demoType) {
            renderA2UIDemo(demoType);
          } else {
            addMessage('This is a placeholder response. AI integration coming soon!', 'ai', false);
          }
        }, 800);
      }, 500);
    } else {
      // æ²¡æœ‰æ¬¢è¿æ¶ˆæ¯ï¼Œæ­£å¸¸æ·»åŠ 
      addMessage(message, 'user', false);
      
      // åˆ¤æ–­æ˜¯å¦æ¸²æŸ“ A2UI æˆ–æ™®é€šå›å¤
      setTimeout(() => {
        if (demoType) {
          renderA2UIDemo(demoType);
        } else {
          addMessage('This is a placeholder response. AI integration coming soon!', 'ai', false);
        }
      }, 1000);
    }

    // æ¸…ç©ºè¾“å…¥æ¡†
    if (chatInput) {
      chatInput.value = '';
      chatInput.style.height = 'auto';
    }
  }

  function addMessage(text: string, sender: 'user' | 'ai', keepHidden: boolean = false) {
    if (!chatMessages) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    // åˆå§‹çŠ¶æ€ï¼šä¸å ç”¨å¸ƒå±€ç©ºé—´
    messageDiv.style.cssText = 'display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; gap: 0.75rem; align-items: flex-start !important; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease, max-height 0.3s ease;';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    // ä¸éœ€è¦è®¾ç½®å†…è”æ ·å¼ï¼Œè®© CSS æ§åˆ¶
    
    // æ·»åŠ  SVG å›¾æ ‡
    if (sender === 'user') {
      avatar.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="11" fill="rgba(255, 255, 255, 0.1)" stroke="currentColor" stroke-width="1"/>
          <path d="M12 5c1.8 0 3.2 1.4 3.2 3.2S13.8 11.4 12 11.4s-3.2-1.4-3.2-3.2S10.2 5 12 5zm0 7.2c2.4 0 7.2 1.2 7.2 3.6v1.4c0 0.4-0.4 0.8-0.8 0.8H5.6c-0.4 0-0.8-0.4-0.8-0.8v-1.4c0-2.4 4.8-3.6 7.2-3.6z"/>
        </svg>
      `;
    } else {
      avatar.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="12" r="11" fill="rgba(255, 255, 255, 0.1)" stroke="currentColor" stroke-width="1"/>
          <path d="M12 3.5l2.32 4.69L20 9.27l-4 3.9 0.94 5.48L12 16.23l-4.94 2.42L8 13.17 4 9.27l5.68-1.08L12 3.5z"/>
        </svg>
      `;
    }
    
    const content = document.createElement('div');
    content.className = 'message-content a2ui-message-content';
    content.style.cssText = 'flex: 1 1 auto !important; min-width: 0 !important; max-width: 100% !important; padding: 0; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; display: block !important; background: transparent; border: none;';
    
    // æ·»åŠ å…ƒç´ åˆ°æ¶ˆæ¯å®¹å™¨
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    // ä½¿ç”¨ A2UI æ¸²æŸ“å™¨æ¥æ¸²æŸ“æ–‡æœ¬
    const renderer = new A2UIRenderer(content);
    
    // åˆ›å»ºä¸€ä¸ªæ ‡å‡†çš„A2UIæ¶ˆæ¯ï¼ŒåŒ…è£¹åœ¨Cardä¸­
    const textMessage = {
      type: 'createSurface',
      surfaceId: `text-${Date.now()}`,
      components: [
        {
          type: 'Card',
          id: 'message-card',
          elevation: 1,
          children: [
            {
              type: 'Text',
              text: text,
              size: 'medium'
            }
          ]
        }
      ]
    };
    
    renderer.processMessage(textMessage);
    
    // æ·»åŠ åˆ°å®¹å™¨
    chatMessages.appendChild(messageDiv);
    
    // å¦‚æœä¸éœ€è¦ä¿æŒéšè—ï¼Œç«‹å³æ˜¾ç¤ºå¹¶æ»šåŠ¨
    if (!keepHidden) {
      // å…ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ–°æ¶ˆæ¯åœ¨å¯è§†åŒºåŸŸ
      const chatContainer = document.querySelector('.chat-container');
      if (chatContainer) {
        // ç«‹å³æ»šåŠ¨ï¼Œé¿å…æ¶ˆæ¯æ˜¾ç¤ºåœ¨é”™è¯¯ä½ç½®
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
      
      requestAnimationFrame(() => {
        messageDiv.style.opacity = '1';
        messageDiv.style.maxHeight = '200px';
        
        // å†æ¬¡ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
        if (chatContainer) {
          setTimeout(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }, 50); // ç»™åŠ¨ç”»ä¸€ç‚¹æ—¶é—´
        }
      });
    }
  }

  // ============= A2UI Demo åŠŸèƒ½ =============

  function renderA2UIDemo(demoType: keyof typeof allMockExamples) {
    console.log('Rendering A2UI demo:', demoType); // è°ƒè¯•æ—¥å¿—
    if (!chatMessages) return;
    
    // æ·»åŠ  AI æ¶ˆæ¯å®¹å™¨
    const aiMessageDiv = document.createElement('div');
    aiMessageDiv.className = 'message ai-message';
    aiMessageDiv.style.cssText = 'display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; gap: 0.75rem; align-items: flex-start !important; opacity: 0; max-height: 0; overflow: hidden; transition: opacity 0.3s ease, max-height 0.3s ease; width: 100% !important; max-width: 100% !important;';
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
        <circle cx="12" cy="12" r="11" fill="rgba(255, 255, 255, 0.1)" stroke="currentColor" stroke-width="1"/>
        <path d="M12 3.5l2.32 4.69L20 9.27l-4 3.9 0.94 5.48L12 16.23l-4.94 2.42L8 13.17 4 9.27l5.68-1.08L12 3.5z"/>
      </svg>
    `;
    
    const content = document.createElement('div');
    content.className = 'message-content a2ui-message-content';
    content.style.cssText = 'flex: 1 1 auto !important; min-width: 0 !important; max-width: 100% !important; padding: 0; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; display: block !important; background: transparent; border: none;';
    
    aiMessageDiv.appendChild(avatar);
    aiMessageDiv.appendChild(content);
    chatMessages.appendChild(aiMessageDiv);
    
    // æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„æ¸²æŸ“å™¨å®ä¾‹ï¼Œç¡®ä¿æ¯æ¡æ¶ˆæ¯ç‹¬ç«‹
    const renderer = new A2UIRenderer(content);
    console.log('Renderer created'); // è°ƒè¯•æ—¥å¿—
    
    // ç›‘å¬ action äº‹ä»¶
    content.addEventListener('a2ui:action', ((e: CustomEvent) => {
      console.log('A2UI Action:', e.detail);
      alert(`Action: ${e.detail.actionName}\nData: ${JSON.stringify(e.detail.dataModel, null, 2)}`);
    }) as EventListener);
    
    // å¤„ç†æ‰€æœ‰æ¶ˆæ¯
    const messages = allMockExamples[demoType];
    console.log('Messages to render:', messages); // è°ƒè¯•æ—¥å¿—
    
    try {
      messages.forEach((msg: any, index: number) => {
        console.log(`Processing message ${index}:`, msg); // è°ƒè¯•æ—¥å¿—
        renderer.processMessage(msg);
      });
      console.log('All messages processed successfully'); // è°ƒè¯•æ—¥å¿—
    } catch (error) {
      console.error('Error processing messages:', error); // é”™è¯¯æ—¥å¿—
    }
    
    // å…ˆæ»šåŠ¨åˆ°åº•éƒ¨ï¼Œç¡®ä¿æ–°æ¶ˆæ¯åœ¨å¯è§†åŒºåŸŸ
    const chatContainer = document.querySelector('.chat-container');
    if (chatContainer) {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯
    requestAnimationFrame(() => {
      aiMessageDiv.style.opacity = '1';
      aiMessageDiv.style.maxHeight = 'none';
      aiMessageDiv.style.overflow = 'visible';
      
      // å†æ¬¡ç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
      if (chatContainer) {
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100); // ç»™A2UIç»„ä»¶æ¸²æŸ“ä¸€ç‚¹æ—¶é—´
      }
    });
  }
</script>
</html>
